{% extends "_layouts/base.html" %}

{% block breadcrumbs %}
    <li>–¢—Ä–µ–≤–µ–ª</li>
{% endblock %}

{% macro input(label, placeholder, type='text', id='', container_cls='', value='', required=True) %}
    <label class="form-control w-full {{ container_cls }}">
        <div class="label ">
            <span class="label-text">{{ label }}</span>
        </div>
        <input id="{{ id }}" type="{{ type }}" placeholder="{{ placeholder }}" value="{{ value }}"
               {% if required %}required{% endif %}
               class="input input-sm input-bordered w-full    "/>
    </label>
{% endmacro %}

{% block main %}
    <ul>
        <li><a href="#places">–ì–¥–µ –±—ã–ª–∏ üåç</a></li>
        <li><a href="#tickets">–ë–∏–ª–µ—Ç—ã üé´</a></li>
        <li><a href="#live">–ì–¥–µ –∂–∏—Ç—å üè®</a></li>
    </ul>

    <h2 id="places">–ì–¥–µ –±—ã–ª–∏ üåç</h2>
    <div class="flex flex-wrap gap-2">
        {% for place in places %}
            <span {% if place.comment %}title="{{ place.comment }}"
                  class="border-b-2 border-dotted cursor-help border-neutral"{% endif %}>
                {{ place.city }} ({{ place.date[:7] }})
            </span>
            {% if not loop.last %}‚Ä¢{% endif %}
        {% endfor %}
    </div>

    <h2 id="tickets">–ë–∏–ª–µ—Ç—ã üé´</h2>

    <div class="border rounded-lg border-neutral shadow px-4 py-2">
        <h3>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –Ω–∞–¥ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º–∏</h3>
        <cite class="block">–ò—â–µ—Ç –±–∏–ª–ª—ã —Å—Ä–∞–∑—É –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å–∞–π—Ç–∞–º: –∞–≤–∏–∞—Å–µ–π–ª–∑, –∫—É–ø–∏–±–∏–ª–µ—Ç, —Ç–∏–Ω—å–∫, —è–Ω–¥–µ–∫—Å, –æ–∑–æ–Ω</cite>
        <cite class="block">–í–∞–∂–Ω–æ: –ù—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤—Å–ø–ª—ã–≤–∞—à–µ–∫</cite>

        <form class="flex gap-2 items-end " onsubmit="openLinks(params)">
            {{ input('–û—Ç–∫—É–¥–∞', 'IATA', id='fromIata', container_cls='dropdown', value='–ú–æ—Å–∫–≤–∞ - MOW') }}
            {{ input('–ö—É–¥–∞', 'IATA', id='toIata', container_cls='dropdown') }}
            {{ input('–ö–æ–≥–¥–∞ —Ç—É–¥–∞', '',   id='fromDate', type='date') }}
            {{ input('–ö–æ–≥–¥–∞ –æ—Ç—Ç—É–¥–∞', '', id='toDate' ,type= 'date') }}
            <button class="btn btn-primary btn-sm ">–ì–æ</button>
        </form>
    </div>

    {##}



    <h3>–ì–¥–µ –±—Ä–∞—Ç—å?</h3>
    <div>
        <ul>
            <li>–ë–∏–ª–µ—Ç—ã ‚Äî –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö –≤–µ—â–µ–π –ø—Ä–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏</li>
            <li><b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –Ω–∞–¥–æ –ø–æ–∫—É–ø–∞—Ç—å –±–∏–ª–µ—Ç—ã –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ / –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç / —Ç—É–ø–∞ –Ω–∞ –∞–≤–∏–∞—Å–µ–π–ª–∑</b></li>
            <li>
                –ò –≤—Å–µ –∂–µ, —Å–∞–º—ã–µ –ø—Ä–æ—Å—Ç—ã–µ –≤–∞—Ä–∏–∫–∏:
                <a href="https://www.aviasales.ru/">–ê–≤–∏–∞—Å–µ–π–ª–∑</a>,
                <a href="https://www.kupibilet.ru/">–ö—É–ø–∏–±–∏–ª–µ—Ç</a>
            </li>
            <li>
                <b>–ê –≥–¥–µ –µ—â–µ?</b> –î–∞ –≤–µ–∑–¥–µ:
                <a href="https://www.tinkoff.ru/travel/flights/">–¢–∏–Ω—å–∫</a>,
                <a href="https://travel.yandex.ru/avia/">–Ø–Ω–¥–µ–∫—Å</a>,
                <a href="https://www.ozon.ru/travel/">–û–∑–æ–Ω</a>
            </li>

            <li>–ê —Å–º—ã—Å–ª? –°–º—ã—Å–ª –≤ —Ç–æ–º, —á—Ç–æ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –∫–∞–∂–¥—ã–π –∏–∑ —ç—Ç–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –∫–µ—à–±–µ–∫ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–ª—é—à–∫–∏
                –∏
                —Å—Ç–æ–∏—Ç –≤—Å–µ –∏—Ö –ø—Ä–æ—á–µ–∫–∞—Ç—å, –≤–¥—Ä—É–≥ —Ö–æ—Ä–æ—à–∏–µ –≤–∞—Ä–∏–∫–∏
            </li>
            <li>
                –í–æ—Ç –∞–≤–∏–∞—Å–µ–π–ª–∑: <img src="/templates/travel/aviasales.png">
            </li>
            <li>
                –ê –≤–æ—Ç —Ç–µ –∂–µ –±–∏–ª–ª—ã –≤ —Ç–∏–Ω—å–∫–µ: <img src="/templates/travel/tink.png">

                –¢–æ –µ—Å—Ç—å –∏ –¥–µ—à–µ–≤–ª–µ, –∏ –∫–µ—à–±–µ–∫, –∞ –∫–µ—à–±–µ–∫ –º–æ–∂–µ—Ç –≤—ã–ø–∞—Å—Ç—å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –Ω–∞ –º–µ—Å—è—Ü, –∞ –µ—â–µ –º–æ–∂–Ω–æ –ø—Ä–µ–º–∏—É–º
                –ø–æ–¥–∫–ª—é—á–∏—Ç—å, –∏ –≤—Å–µ —ç—Ç–æ –≤ –ø—Ä–∏–≤—ã—á–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ–ª–æ–¥–≤–∏–∂–µ–Ω–∏–π - –∫—Ä—á –∫–∞–π—Ñ—ã
            </li>
            <li>
                –ò–ª–∏ –æ–ø—è—Ç—å –∂–µ —è–Ω–¥–µ–∫—Å: <img src="/templates/travel/ya.png">

                –¢–æ–∂–µ –≤–∞—Ä–∏–∫ –¥–µ—à–µ–≤–ª–µ –≤—Å–µ—Ö
            </li>
            <li>
                –ê –æ–∑–æ–Ω –∏ —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π –∏ —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –∫–µ—à–±–µ–∫: <img src="/templates/travel/ozon.png">
            </li>
            <li>
                –ö—Ä—á –µ—â–µ —Ä–∞–∑ <b>–±–∏–ª–µ—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ –ø–∏–∑–¥—ã, —Å—Ç–æ–∏—Ç –ø–æ—Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –≤–∞—Ä–∏–∫–∏</b>
            </li>


            <li><b>–ß–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–º?</b>
                <ul>
                    <li><i><b>–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫ All Airlines</b></i> - –ø–æ –∏–¥–µ–µ –∫–µ—à–±–µ–∫ –±—É–¥–µ—Ç –∫–∞–ø–∞—Ç—å –∫–∞–∫ –º–∏–ª–∏, –∞ –º–∏–ª–∏ –º–æ–∂–Ω–æ
                        —Ç—Ä–∞—Ç–∏—Ç—å
                        –Ω–∞
                        –±–∏–ª–ª—ã, <i>–Ω–æ –Ω–∞–¥–æ –¢–∏–Ω—å–∫ –ü—Ä–µ–º–∏—É–º –∏–ª–∏ 2–∫/–º–µ—Å.</i></li>
                </ul>
            </li>
        </ul>

        <h3>–°–∞–º–æ–ª–µ—Ç–∏–∫–∏ ‚úàÔ∏è</h3>

        <h4>–ê—ç—Ä–æ—Ñ–ª–æ—Ç ü©µ</h4>

        <ul class="li-plus">
            <li>–û–Ω–ª–∞–π–Ω —Ä–µ–≥–∞ –∑–∞ –¥–µ–Ω—å</li>
            <li>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫—Ä–µ—Å–ª–∞–º–∏ - –±–æ–ª—å—à–æ–µ, –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–µ</li>
            <li>–†—É—á–Ω–∞—è –∫–ª–∞–¥—å</li>
            <li>–ü–∏—Ç–∞–Ω–∏–µ (–ø—Ä–∏ –ø–æ–ª–µ—Ç–µ 4—á+)</li>
            <li>–ü–æ–¥—Å—Ç–∞–≤–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞</li>
        </ul>

        <ul class="li-minus">
            <li>–¶–µ–Ω–∞</li>
        </ul>

        <h4>–Ø–∫—É—Ç–∏—è</h4>
        <ul class="li-plus">
            <li>–ü–∏—Ç–∞–Ω–∏–µ (–ø—Ä–∏ –ø–æ–ª–µ—Ç–µ 4—á+)</li>
            <li>–¶–µ–Ω–∞</li>
            <li>–†—É—á–Ω–∞—è –∫–ª–∞–¥—å</li>
        </ul>
        <ul class="li-minus">
            <li>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫—Ä–µ—Å–ª–∞–º–∏ - –≤–ø—Ä–∏—Ç—ã–∫</li>
            <li>–†–µ–≥–∞ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É</li>
            <li>–ù–µ—Ç –¥–µ—Ä–∂–∞–ª–∫–∏</li>
        </ul>

        <h4>–ü–æ–±–µ–¥–∞</h4>
        <ul class="li-minus">
            <li>–ü—Ä–æ—Å—Ç–æ —Ç—Ä–µ—à, –æ–±—Ö–æ–¥–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω–æ–π, –≤—Å–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –Ω–æ –Ω–µ –ü–æ–±–µ–¥–∞</li>
        </ul>


    </div>

    <h2 id="live">–ì–¥–µ –∂–∏—Ç—å üè®</h2>
    <div>
        <ul>
            <li>
                <a href="https://sutochno.ru/">–°—É—Ç–æ—á–Ω–æ</a> - –∞—Ä–µ–Ω–¥–∞ —Ö–∞—Ç—ã –ø–æ—Å—É—Ç–æ—á–Ω–æ
            </li>
            <li>
                <a href="https://ostrovok.ru/?sid=be485918-c5e0-47d1-b5db-33ff46746684">–û—Å—Ç—Ä–æ–≤–æ–∫</a> - –≥–æ—Å—Ç–∏–∂–∫–∏
            </li>
            <li>
                –¢–µ –∂–µ —Å–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–¥–∞—é—Ç –±–∏–ª–ª—ã –Ω–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫, –ø—Ä–æ–¥–∞—é—Ç –∏ –±–∏–ª–ª—ã –≤ –≥–æ—Å—Ç–∏–∂–∫–∏:
                <a href="https://www.tinkoff.ru/travel/hotels/new/">–¢–∏–Ω—å–∫</a>,
                <a href="https://travel.yandex.ru/hotels/">–Ø–Ω–¥–µ–∫—Å</a>,
                <a href="https://www.ozon.ru/travel/hotels/">–û–∑–æ–Ω</a>
            </li>
        </ul>

        <h4>–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—â–∏ –∫–æ–≥–¥–∞ —Ä–∞–Ω–Ω–µ–µ –≤—ã—Å–µ–ª–µ–Ω–∏–µ </h4>
        <ul>
            <li><b>–¢–∞–º –∂–µ –≤ –≥–æ—Å—Ç–∏–∂–∫–µ / –∫–≤–∞—Ä—Ç–∏—Ä–µ</b>, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</li>
            <li><b>–í–æ–∫–∑–∞–ª</b> - –∑–∞—á–∞—Å—Ç—É—é —Ç–∞–º –µ—Å—Ç—å –∫–∞–º–µ—Ä—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è</li>
            <li><a href="https://ostavbagaz.ru/">–û—Å—Ç–∞–≤—å–±–∞–≥–∞–∂</a> - —Å–µ—Ä–≤–∏—Å, –æ—á–µ–≤–∏–¥–Ω–æ, —Å –º–µ—Å—Ç–∞–º–∏ –≥–¥–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–∞–≥–∞–∂
                (–Ω–∞–ø—Ä. –≤ –Ø—Ä–∏–∫–µ —Å–¥–∞–ª–∏ –±–∞–≥–∞–∂ –≤ —Ä–∞–Ω–¥–æ–º–Ω—É—é –≥–æ—Å—Ç–∏–∂–∫—É –∑–∞ —Ç—Ä–∏ —Å–æ—Ç–∫–∏)
            </li>
            <li>–ü—Ä–∏–Ω—Ü–∏–ø —Ç–æ—Ç –∂–µ - <b>—Ç—É–ø–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–∞—Ä–∏–∫–∏</b></li>
        </ul>
    </div>


    <script src="{{ url_for('static', filename='js/autoComplete.min.js') }}"></script>
    <script>
        let params = {
            fromIata: 'MOW',
            toIata: 'OVB',
            fromDate: new Date('2024-05-05'),
            toDate: new Date('2024-05-10'),
        }

        const makeAutocomplete = (selector, callback) => {
            return new autoComplete({
                selector,
                data: {
                    src: async (query) => {
                        try {
                            const source = await fetch(`https://autocomplete.travelpayouts.com/places2?locale=ru&types[]=city&types[]=airport&term=${query}`);
                            let data = await source.json();
                            data = data.map(item => ({
                                value: item.code,
                                label: `${item.name} - ${item.code}`
                            }))
                            return data;
                        } catch (error) {
                            return error;
                        }
                    },
                    keys: ["label"],
                },
                resultsList: {
                    tag: 'ul',
                    class: 'dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52'
                },
                resultItem: {
                    class: 'not-prose',
                    element: (item, data) => {
                        item.innerHTML = `<a>${data.match}</a>`
                    },
                },

                events: {
                    input: {
                        selection: (event) => {
                            const selection = event.detail.selection.value;
                            event.target.value = selection.label;
                            callback(selection.value)
                        }
                    }
                }
            });
        };

        const fromIataAutoComplete = makeAutocomplete('#fromIata', value => params.fromIata = value);
        const toIataAutoComplete = makeAutocomplete('#toIata', value => params.toIata = value);

        function openLinks(params) {
            params.fromDate = new Date(document.querySelector('#fromDate').value);
            params.toDate = new Date(document.querySelector('#toDate').value);

            function format_date(date, service) {
                const isoDate = date.toISOString().split('T')[0]
                const [year, month, day] = isoDate.split('-')
                switch (service) {
                    case 'aviasales':
                        return `${day}${month}`
                    case 'tink':
                        return `${month}-${day}`
                    case 'kupibilet':
                    case 'ozon':
                        return isoDate
                }
            }


            const avisales = (params) => {
                let from = params.fromIata + format_date(params.fromDate, 'aviasales');
                let to = params.toIata + format_date(params.toDate, 'aviasales');
                return `https://www.aviasales.ru/search/${from}${to}2`
            }

            const kupibilet = (params) => {
                let fromDate = format_date(params.fromDate, 'kupibilet');
                let toDate = format_date(params.toDate, 'kupibilet');
                const route0 = `iatax:${params.fromIata}_${fromDate}_date_${fromDate}_iatax:${params.toIata}`;
                const route1 = `iatax:${params.toIata}_${toDate}_date_${toDate}_iatax:${params.fromIata}`
                return `https://www.kupibilet.ru/search?adult=2&cabinClass=Y&child=0&childrenAges=[]&infant=0&route[0]=${route0}&route[1]=${route1}&v=2`
            }

            const tink = (params) => {
                let fromRoute = `${params.fromIata}-${params.toIata}`
                let fromDate = format_date(params.fromDate, 'tink');
                let toRoute = `${params.toIata}-${params.fromIata}`
                let toDate = format_date(params.toDate, 'tink');
                return `https://www.tinkoff.ru/travel/flights/multi-way/${fromRoute}/${fromDate}/${toRoute}/${toDate}/?adults=2&children=0&infants=0&cabin=Y&composite=0`
            }
            const yandex = (params) => `https://travel.yandex.ru/avia/`
            const ozon = (params) => {
                let fromDate = format_date(params.fromDate, 'ozon')
                let toDate = format_date(params.toDate, 'ozon')
                let route = `${params.fromIata}${params.toIata}${params.toIata}${params.fromIata}`.toLowerCase();
                return `https://www.ozon.ru/travel/flight/search?Children=0&Dlts=2&Infants=0&ServiceClass=ECONOMY&dates=d${fromDate}d${toDate}&route=${route}&step=search&travelSearchType=simpleAvia`
            }

            [
                avisales,
                kupibilet,
                tink,
                yandex,
                ozon,
            ].forEach((service, index) => {
                let url = service(params)
                console.log(url)


                // let link = document.createElement('a');
                // link.href = url;
                // link.target = '_blank';
                // link.click();

                window.open(url, '_blank' + index)

            })
        }
    </script>
{% endblock %}
